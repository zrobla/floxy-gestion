{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Tâches</h1>

{% if can_manage %}
<div class="accordion mb-4" id="createTaskAccordion">
  <div class="accordion-item brand-card form-card">
    <h2 class="accordion-header">
      <button
        class="accordion-button {% if not open_form %}collapsed{% endif %}"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#createTaskCollapse"
      >
        Créer une tâche
      </button>
    </h2>
    <div
      id="createTaskCollapse"
      class="accordion-collapse collapse {% if open_form %}show{% endif %}"
      data-bs-parent="#createTaskAccordion"
    >
      <div class="accordion-body">
        <form method="post" class="compact-form">
          {% csrf_token %}
          {{ form.as_p }}
          <button class="btn btn-save" type="submit" name="create_task">Enregistrer</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% else %}
<div class="alert alert-info">Création réservée aux managers.</div>
{% endif %}

<div class="card brand-card">
  <div class="card-header">Liste des tâches</div>
  <div class="card-body">
    {% for task in tasks %}
    <div class="border rounded p-3 mb-3 bg-white">
      <div class="d-flex justify-content-between">
        <div>
          <h5 class="mb-1">{{ task.title }}</h5>
          <p class="mb-1 text-muted">Assignée à : {{ task.assigned_to|default:"-" }}</p>
          <p class="mb-1">
            Statut :
            {% if task.status == "DONE" %}
            <span class="badge badge-status badge-status--done">{{ task.get_status_display }}</span>
            {% elif task.status == "IN_PROGRESS" %}
            <span class="badge badge-status badge-status--progress">{{ task.get_status_display }}</span>
            {% elif task.status == "TODO" %}
            <span class="badge badge-status badge-status--info">{{ task.get_status_display }}</span>
            {% elif task.status == "CANCELED" %}
            <span class="badge badge-status badge-status--warn">{{ task.get_status_display }}</span>
            {% else %}
            <span class="badge badge-status bg-secondary">{{ task.get_status_display }}</span>
            {% endif %}
            {% if task.is_overdue %}
            <span class="badge badge-status badge-status--warn">Échéance dépassée</span>
            {% endif %}
          </p>
        </div>
        <div>
          <form method="post" class="d-flex gap-2">
            {% csrf_token %}
            <input type="hidden" name="task_id" value="{{ task.id }}" />
            <select name="status" class="form-select form-select-sm">
              {% for value,label in form.fields.status.choices %}
              <option value="{{ value }}" {% if value == task.status %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-sm btn-secondary-premium" type="submit" name="set_status">Mettre à jour</button>
          </form>
        </div>
      </div>

      <div class="mt-3">
        <strong>Checklist</strong>
        <ul class="list-group list-group-flush mb-2">
          {% for item in task.checklist_items.all %}
          <li class="list-group-item">{{ item.label }} {% if item.is_done %}✅{% endif %}</li>
          {% empty %}
          <li class="list-group-item text-muted">Aucun élément.</li>
          {% endfor %}
        </ul>
        {% if can_manage %}
        <form method="post" class="d-flex gap-2 compact-form">
          {% csrf_token %}
          <input type="hidden" name="task_id" value="{{ task.id }}" />
          <input type="text" name="label" class="form-control" placeholder="Nouvel élément" />
          <input type="number" name="order" class="form-control" placeholder="Ordre" value="0" />
          <button class="btn btn-save" type="submit" name="add_checklist">Ajouter</button>
        </form>
        {% endif %}
      </div>
    </div>
    {% empty %}
    <p class="text-muted">Aucune tâche.</p>
    {% endfor %}
  </div>
</div>
{% endblock %}
