{% extends "base.html" %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-3">
  <div>
    <h1 class="mb-1">Dashboard général</h1>
    <p class="text-muted mb-0">Vue d'ensemble du {{ start_date|date:"d/m/Y" }} au {{ end_date|date:"d/m/Y" }}.</p>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-secondary-premium btn-sm" href="?days=7{% if selected_service %}&service={{ selected_service }}{% endif %}{% if selected_sector %}&sector={{ selected_sector }}{% endif %}">7 jours</a>
    <a class="btn btn-secondary-premium btn-sm" href="?days=30{% if selected_service %}&service={{ selected_service }}{% endif %}{% if selected_sector %}&sector={{ selected_sector }}{% endif %}">30 jours</a>
    <a class="btn btn-secondary-premium btn-sm" href="?days=90{% if selected_service %}&service={{ selected_service }}{% endif %}{% if selected_sector %}&sector={{ selected_sector }}{% endif %}">90 jours</a>
    <form method="get" class="d-flex flex-wrap gap-2 align-items-center">
      <span class="text-muted">Du</span>
      <input
        type="text"
        name="start"
        class="form-control form-control-sm date-picker"
        value="{{ start_input }}"
        placeholder="jj/mm/aaaa"
      />
      {% if dashboard_error %}
      <span class="text-danger small">{{ dashboard_error }}</span>
      {% endif %}
      <span class="text-muted">Au</span>
      <input
        type="text"
        name="end"
        class="form-control form-control-sm date-picker"
        value="{{ end_input }}"
        placeholder="jj/mm/aaaa"
      />
      <select name="sector" class="form-select form-select-sm">
        <option value="">Toutes catégories</option>
        {% for category in prestation_categories %}
        <option value="{{ category.name }}" {% if category.name == selected_sector %}selected{% endif %}>{{ category.name }}</option>
        {% endfor %}
      </select>
      <select name="service" class="form-select form-select-sm">
        <option value="">Toutes prestations</option>
        {% for service in prestation_services %}
        <option value="{{ service.id }}" {% if service.id|stringformat:"s" == selected_service %}selected{% endif %}>{{ service.name }}</option>
        {% endfor %}
      </select>
      {% if dashboard_error %}
      <span class="text-danger small">{{ dashboard_error }}</span>
      {% endif %}
      <button class="btn btn-save btn-sm" type="submit">Appliquer</button>
    </form>
  </div>
</div>

{% if dashboard_error %}
<div class="text-danger small mb-3">
  Vérifiez les dates au format jj/mm/aaaa pour le filtre de période.
</div>
{% endif %}

<div class="row g-4">
  <div class="col-md-4">
    <div class="card brand-card">
      <div class="card-body">
        <h5 class="card-title">Activités</h5>
        <p class="card-text">{{ activities_total }} activité(s).</p>
        <span class="badge badge-status badge-status--done">{{ activities_paid }} payée(s)</span>
        <div class="sparkline">
          <span style="height: 12px"></span>
          <span style="height: 20px"></span>
          <span style="height: 16px"></span>
          <span style="height: 22px"></span>
          <span style="height: 14px"></span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card brand-card">
      <div class="card-body">
        <h5 class="card-title">Chiffre d'affaires</h5>
        <p class="card-text">{{ revenue_expected }} FCFA attendus.</p>
        <span class="badge badge-status badge-status--info">{{ revenue_final }} FCFA encaissés</span>
        <div class="sparkline">
          <span style="height: 10px"></span>
          <span style="height: 18px"></span>
          <span style="height: 24px"></span>
          <span style="height: 16px"></span>
          <span style="height: 20px"></span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card brand-card">
      <div class="card-body">
        <h5 class="card-title">Tâches</h5>
        <p class="card-text">{{ tasks_done }}/{{ tasks_total }} terminées.</p>
        <span class="badge badge-status badge-status--warn">{{ tasks_overdue }} en retard</span>
        <div class="sparkline">
          <span style="height: 8px"></span>
          <span style="height: 14px"></span>
          <span style="height: 20px"></span>
          <span style="height: 16px"></span>
          <span style="height: 12px"></span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card brand-card">
      <div class="card-body">
        <h5 class="card-title">Contenus</h5>
        <p class="card-text">{{ content_total }} contenus produits.</p>
        <span class="badge badge-status badge-status--purple">{{ content_approved }} validés</span>
        <div class="sparkline">
          <span style="height: 12px"></span>
          <span style="height: 18px"></span>
          <span style="height: 22px"></span>
          <span style="height: 16px"></span>
          <span style="height: 20px"></span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card brand-card">
      <div class="card-body">
        <h5 class="card-title">Performance contenu</h5>
        <p class="card-text">Score moyen {{ content_score_avg }}.</p>
        <span class="badge badge-status badge-status--info">{{ content_published }} publiés</span>
        <div class="sparkline">
          <span style="height: 12px"></span>
          <span style="height: 16px"></span>
          <span style="height: 24px"></span>
          <span style="height: 18px"></span>
          <span style="height: 14px"></span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card brand-card">
      <div class="card-body">
        <h5 class="card-title">Progression tâches</h5>
        <p class="card-text">{{ tasks_completion_rate }}% de complétion.</p>
        <div class="progress" style="height: 10px;">
          <div class="progress-bar" role="progressbar" style="width: {{ tasks_completion_rate }}%"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-lg-6">
    <div class="card brand-card">
      <div class="card-body">
        <h5 class="card-title">Répartition par plateforme</h5>
        <ul class="list-group list-group-flush">
          {% for item in platform_breakdown %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ item.label }}</span>
            <span class="badge badge-status badge-status--info">{{ item.count }}</span>
          </li>
          {% empty %}
          <li class="list-group-item text-muted">Aucune donnée disponible.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card brand-card">
      <div class="card-body">
        <h5 class="card-title">Synthèse</h5>
        <p class="mb-2">Période : du {{ start_date|date:"d/m/Y" }} au {{ end_date|date:"d/m/Y" }}.</p>
        <p class="mb-1">Objectif : améliorer le taux de complétion et l'engagement.</p>
        <p class="text-muted mb-0">Utilisez les filtres ci-dessus pour ajuster la période.</p>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-12">
    <div class="card brand-card">
      <div class="card-body">
        <h5 class="card-title">Mix prestations (encaissé)</h5>
        <p class="text-muted">Basé sur les activités payées de la période.</p>
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead>
              <tr>
                <th>Prestation</th>
                <th>Volume</th>
                <th>Quantité</th>
                <th>CA</th>
                <th>Ticket moyen</th>
              </tr>
            </thead>
            <tbody>
              {% for item in prestations_breakdown %}
              <tr>
                <td>{{ item.name }}</td>
                <td>{{ item.total_lines }}</td>
                <td>{{ item.total_qty }}</td>
                <td>{{ item.revenue }}</td>
                <td>{{ item.avg_ticket }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted">Aucune prestation encaissée sur la période.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
